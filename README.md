<div align="center">
  <h1 align="center">ğŸš€ Cybertemp SMTP Server</h1>
  <p align="center">
    A high-performance, production-ready SMTP receive-only server powering Cybertemp's temporary and private email infrastructure. Built with Rust for speed, reliability, and concurrency.
    <br />
    <br />
    <a href="https://discord.cyberious.xyz">ğŸ’¬ Discord</a>
    Â·
    <a href="#-changelog">ğŸ“œ ChangeLog</a>
    Â·
    <a href="https://github.com/sexfrance/smtp-server/issues">âš ï¸ Report Bug</a>
    Â·
    <a href="https://github.com/sexfrance/smtp-server/issues">ğŸ’¡ Request Feature</a>
  </p>
</div>

---

## ğŸ“– Table of Contents

- [About](#-about)
- [Architecture](#ï¸-architecture)
- [Features](#-features)
- [Prerequisites](#-prerequisites)
- [Installation](#ï¸-installation)
- [Configuration](#-configuration)
- [Database Setup](#-database-setup)
- [Running the Server](#-running-the-server)
- [How It Works](#-how-it-works)
- [Important Notes](#-important-notes)
- [Troubleshooting](#-troubleshooting)
- [Development Status](#-development-status)
- [ChangeLog](#-changelog)

---

## ğŸ“š About

**THIS README IS ENTIRLY GENERATED BY AI I DID NOT WRITE THIS SHIT**

**This is the actual SMTP server currently powering [Cybertemp](https://cybertemp.xyz)** - a temporary email service handling thousands of emails daily. The codebase is functional and battle-tested in production, though the code quality could use some refactoring (it works, but it's a bit messy ).

This server is designed as a **receive-only SMTP server** that:

- Accepts incoming emails on port 25 (or custom port)
- Stores temporary emails in PostgreSQL
- Integrates with Supabase for inbox management
- Supports private email accounts (optional feature used by Cybertemp)
- Implements domain whitelisting and email/domain banning
- Handles concurrent connections efficiently with Tokio async runtime

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Incoming SMTP  â”‚
â”‚   Port 25/2525  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Rust SMTP Server (Tokio)      â”‚
â”‚  - Concurrent connection handler â”‚
â”‚  - Email parsing (mailparse)     â”‚
â”‚  - Domain whitelist checking     â”‚
â”‚  - Ban list filtering            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚ â”‚   Supabase   â”‚ â”‚  Heartbeat   â”‚
â”‚  (Temp Emails)  â”‚ â”‚  (Inboxes)   â”‚ â”‚  Monitoring  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¥ Features

- âœ… **Production-Ready**: Currently handling Cybertemp's email traffic
- âœ… **High Performance**: Async Rust with Tokio for concurrent connections and super fast
- âœ… **Dual Email System**: Supports both temporary and private emails
- âœ… **Domain Whitelisting**: Accept emails only for configured domains
- âœ… **Ban System**: Block emails from specific senders/domains
- âœ… **MIME Parsing**: Proper handling of plain text and HTML emails
- âœ… **PostgreSQL Storage**: Reliable email storage with indexing
- âœ… **Supabase Integration**: Automatic inbox management
- âœ… **Connection Pooling**: Efficient database connections
- âœ… **Queue Management**: Prevents server overload with request limits
- âœ… **Heartbeat Monitoring**: Optional uptime monitoring endpoint
- âœ… **Real-time Domain Updates**: Polls for domain/ban updates every 30-60s
- âœ… **Graceful Error Handling**: Detailed logging with tracing

---

## ğŸ“‹ Prerequisites

- **Rust** 1.70+ (for compilation)
- **PostgreSQL** 12+ (for email storage)
- **Supabase Account** (for inbox/domain management)
- **Linux/Windows/macOS** (any platform supporting Rust)
- **Port 25 Access** (or alternative SMTP port - requires root/admin on Linux for port 25)

---

## âš™ï¸ Installation

### Using Rust (Recommended - Active Development)

> âš ï¸ **Note**: The JavaScript version is **NOT MAINTAINED**. Use the Rust implementation in the `rust/` directory.

1. **Install Rust** (if not already installed):

   ```bash
   # Linux/macOS
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

   # Windows
   # Download from https://rustup.rs/
   ```

2. **Clone the repository**:

   ```bash
   git clone https://github.com/sexfrance/smtp-server.git
   cd smtp-server/rust
   ```

3. **Build the project**:

   ```bash
   # Development build
   cargo build

   # Production build (optimized)
   cargo build --release
   ```

---

## ğŸ”§ Configuration

Create a `.env` file in the `rust/` directory with the following variables:

```env
# PostgreSQL Database (REQUIRED)
DATABASE_URL=postgresql://username:password@localhost:5432/cybertemp

# Supabase Configuration (REQUIRED)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# SMTP Server Settings (OPTIONAL)
SMTP_RECEIVE_PORT=25                    # Default: 25 (use 2525 for non-root testing)

# Heartbeat Monitoring (OPTIONAL)
HEARTBEAT_URL=https://your-monitoring-service.com/ping
```

### Environment Variables Explained

| Variable                    | Required | Description                                     |
| --------------------------- | -------- | ----------------------------------------------- |
| `DATABASE_URL`              | âœ… Yes   | PostgreSQL connection string for storing emails |
| `SUPABASE_URL`              | âœ… Yes   | Your Supabase project URL                       |
| `SUPABASE_SERVICE_ROLE_KEY` | âœ… Yes   | Supabase service role key (NOT anon key)        |
| `SMTP_RECEIVE_PORT`         | âŒ No    | SMTP port (default: 25)                         |
| `HEARTBEAT_URL`             | âŒ No    | Uptime monitoring ping URL                      |

---

## ğŸ’¾ Database Setup

### PostgreSQL Schema

Run the SQL schema located in `rust/SQL/schema.sql`:

```bash
psql -U your_user -d cybertemp -f rust/SQL/schema.sql
```

This creates:

- `emails` table - stores all temporary emails
- `private_email` table - optional private email accounts (see below)
- Necessary indexes for performance

### Supabase Tables

You need to create these tables in your Supabase project:

#### 1. `domains` table (Domain Whitelist)

```sql
CREATE TABLE domains (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  domain TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add your domains
INSERT INTO domains (domain) VALUES
  ('cybertemp.xyz'),
  ('temp-mail.xyz'),
  ('*.example.com');  -- Wildcard support
```

#### 2. `inbox` table (Inbox Management)

```sql
CREATE TABLE inbox (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email_address TEXT NOT NULL UNIQUE,
  user_id UUID,  -- Optional: link to auth.users
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 3. `bans` table (Email/Domain Blocking)

```sql
CREATE TABLE bans (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  scope TEXT NOT NULL,           -- 'email' or 'domain'
  value TEXT NOT NULL,            -- email address or domain
  match_type TEXT DEFAULT 'exact', -- 'exact' or 'contains'
  status TEXT DEFAULT 'active',   -- 'active' or 'inactive'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Example bans
INSERT INTO bans (scope, value, match_type, status) VALUES
  ('email', 'spam@example.com', 'exact', 'active'),
  ('email', 'spam', 'contains', 'active'),  -- Blocks any email containing "spam"
  ('domain', 'spammer.com', 'exact', 'active');
```

---

## ğŸš€ Running the Server

### Development Mode

```bash
cd rust
cargo run
```

### Production Mode

```bash
cd rust
cargo build --release
./target/release/cybertemp_smtp
```

### Running on Port 25 (Linux)

Port 25 requires root privileges:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant port binding capability (recommended)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp
./target/release/cybertemp_smtp
```

### Running as a Service (Systemd)

Create `/etc/systemd/system/cybertemp-smtp.service`:

```ini
[Unit]
Description=Cybertemp SMTP Server
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/smtp-server/rust
Environment="DATABASE_URL=postgresql://user:pass@localhost/cybertemp"
Environment="SUPABASE_URL=https://your-project.supabase.co"
Environment="SUPABASE_SERVICE_ROLE_KEY=your-key"
ExecStart=/path/to/smtp-server/rust/target/release/cybertemp_smtp
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable cybertemp-smtp
sudo systemctl start cybertemp-smtp
sudo systemctl status cybertemp-smtp
```

---

## ğŸ” How It Works

### Email Flow

1. **Connection**: External SMTP server connects to port 25
2. **SMTP Handshake**: Server responds with `220 Cybertemp Mail Receiver`
3. **Domain Check**: Recipient domain is validated against whitelist
4. **Ban Check**: Sender and domain are checked against ban list
5. **Email Receipt**: Server accepts email data until `.` terminator
6. **Parsing**: Email is parsed using `mailparse` crate
7. **Storage Decision**:
   - If recipient is in `private_email` table â†’ Store in PostgreSQL `emails` table
   - Otherwise â†’ Store in PostgreSQL as temporary email + create Supabase inbox
8. **Response**: Server responds with `250 Ok: Message accepted`

### Domain Whitelisting

The server **only accepts emails** for domains listed in Supabase `domains` table. This prevents abuse and unauthorized usage.

**Wildcard support**:

- `example.com` - matches exactly `example.com`
- `*.example.com` - matches `mail.example.com`, `temp.example.com`, etc.

**Automatic updates**: Domain list is refreshed every 60 seconds.

### Ban System

Protects against spam and abuse:

- **Email bans**: Block specific sender addresses
  - `exact` match: Must match exactly
  - `contains` match: Blocks if sender contains substring
- **Domain bans**: Block entire sending domains
- **Real-time updates**: Ban list refreshes every 30 seconds

---

## âš ï¸ Important Notes

### About Private Emails (`privatemail.sql`)

âš ï¸ **The `private_email` table is ONLY used by Cybertemp for paid features and is NOT required for basic SMTP functionality.**

**What it does**:

- Allows specific email addresses to have persistent storage
- Adds an extra layer of security with passwords
- Used for Cybertemp's paid private email accounts
- Completely optional for self-hosted deployments

**How to remove it**:

1. Delete or ignore `rust/SQL/privatemail.sql`
2. Remove the private email check in `main.rs` (lines ~409-447):
   ```rust
   // Remove this entire block:
   match sqlx::query("SELECT id FROM private_email WHERE email = $1 LIMIT 1")
       .bind(&recipient_email)
       .fetch_optional(postgres_pool)
       .await
   {
       // ... entire private email handling logic
   }
   ```

### Code Quality Disclaimer

âš ï¸ **This codebase is functional but not prettily written.** It's a working production system that evolved organically. Known issues:

- Long functions that should be split up
- Some error handling could be more elegant
- Duplicate code in fallback paths
- Comment clutter from debugging sessions

**But it works reliably** and handles thousands of emails daily for Cybertemp. Refactoring PRs welcome! ğŸ˜„

### JavaScript Version

âš ï¸ **The `javascript/` folder is NOT MAINTAINED** - it was an early prototype. Use the Rust version for all deployments.

---

## ğŸ› ï¸ Troubleshooting

### Common Issues

#### 1. "mismatched types - expected &str, found &Result<String, VarError>"

**Problem**: Environment variable not being unwrapped properly.

**Solution**: Make sure `.env` file exists and contains required variables. The error occurs when `env::var()` fails.

```rust
// Fix by adding .expect() or ?
let database_url = env::var("DATABASE_URL")
    .expect("DATABASE_URL must be set in .env file");
```

#### 2. "Failed to connect to PostgreSQL"

**Check**:

- PostgreSQL is running: `systemctl status postgresql`
- Database exists: `psql -l | grep cybertemp`
- Credentials are correct in `DATABASE_URL`
- Schema is initialized: `psql -d cybertemp -c "\dt"`

#### 3. "Failed to load domains from Supabase"

**Check**:

- Supabase URL is correct (https://your-project.supabase.co)
- Service role key is correct (NOT anon key)
- `domains` table exists in Supabase
- Network connectivity to Supabase

#### 4. "Permission denied" binding to port 25

**Solution**:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant capability (Linux only)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp

# Option 3: Use alternative port
SMTP_RECEIVE_PORT=2525 ./target/release/cybertemp_smtp
```

#### 5. Emails not appearing in database

**Check logs for**:

- Domain whitelist rejections
- Ban list rejections
- Database insertion errors
- Parsing errors

**Enable debug logging**:

```bash
RUST_LOG=debug ./target/release/cybertemp_smtp
```

---

## ğŸ“Š Development Status

| Component                     | Status               | Notes                                 |
| ----------------------------- | -------------------- | ------------------------------------- |
| **Rust Implementation**       | âœ… **Active**        | Production-ready, actively maintained |
| **JavaScript Implementation** | âŒ **Abandoned**     | Not maintained, use Rust version      |
| **PostgreSQL Storage**        | âœ… Production        | Stable and tested                     |
| **Supabase Integration**      | âœ… Production        | Stable and tested                     |
| **Private Email Feature**     | âš ï¸ Optional          | Cybertemp-specific, not required      |
| **Code Quality**              | âš ï¸ Needs Refactoring | Works but messy                       |
| **Documentation**             | âœ… Complete          | You're reading it!                    |

---

## ğŸ“œ ChangeLog

```diff
v0.3.0 â‹® 11/01/2025
+ Comprehensive documentation rewrite
+ Clarified private email feature is optional
+ Added extensive troubleshooting guide
+ Documented Supabase table schemas
+ Added systemd service configuration

v0.2.0 â‹® 09/2024
+ Ban system implementation (email/domain blocking)
+ Real-time domain whitelist updates
+ Improved MIME parsing with fallbacks
+ Connection queue management
+ Heartbeat monitoring support

v0.1.0 â‹® 06/2024
! Initial production deployment for Cybertemp
+ PostgreSQL storage implementation
+ Supabase integration
+ Domain whitelisting
+ Private email support
+ Async Tokio runtime
```

---

## ğŸ“ Support

- **Discord**: [discord.cyberious.xyz](https://discord.cyberious.xyz)
- **Email**: support@cybertemp.xyz
- **Issues**: [GitHub Issues](https://github.com/sexfrance/smtp-server/issues)

---

## ğŸ“„ License

MIT License - See LICENSE file for details

---

## ğŸ™ Acknowledgments

- Built with â¤ï¸ for the Cybertemp community
- Powered by Rust ğŸ¦€, Tokio, and PostgreSQL
- Integrated with Supabase for scalable infrastructure

---

<p align="center">
  <img src="https://img.shields.io/badge/Rust-000000?style=for-the-badge&logo=rust&logoColor=white"/>
  <img src="https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white"/>
  <img src="https://img.shields.io/badge/Supabase-181818?style=for-the-badge&logo=supabase&logoColor=white"/>
  <img src="https://img.shields.io/badge/Production-Ready-success?style=for-the-badge"/>
</p>

<div align="center">
  <strong>â­ Star this repo if you found it helpful!</strong>
  <br />
  <sub>Currently powering Cybertemp's email infrastructure ğŸš€</sub>
</div>

- Integrates with Supabase for inbox management

- Supports private email accounts (optional feature used by Cybertemp)### ğŸ“ Usage

- Implements domain whitelisting and email/domain banning

- Handles concurrent connections efficiently with Tokio async runtime1. **Configuration**:

  Edit `input/config.toml`:

---

````toml

## ğŸ—ï¸ Architecture   [dev]

Debug = false

```   Proxyless = false

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Threads = 1

â”‚  Incoming SMTP  â”‚

â”‚   Port 25/2525  â”‚   [data]

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   password = "optional_custom_password"

      â”‚   email_verified = true

      â–¼   ```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚   Rust SMTP Server (Tokio)      â”‚2. **Proxy Setup** (Optional):

â”‚  - Concurrent connection handler â”‚   - Add proxies to `input/proxies.txt` (one per line)

â”‚  - Email parsing (mailparse)     â”‚   - Format: `ip:port` or `user:pass@ip:port`

â”‚  - Domain whitelist checking     â”‚

â”‚  - Ban list filtering            â”‚3. **Running the script**:

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   ```bash

      â”‚   python main.py

      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   ```

      â–¼                 â–¼                â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”4. **Output**:

â”‚   PostgreSQL    â”‚ â”‚   Supabase   â”‚ â”‚  Heartbeat   â”‚   - Created accounts are saved to `output/accounts.txt` (email:password)

â”‚  (Temp Emails)  â”‚ â”‚  (Inboxes)   â”‚ â”‚  Monitoring  â”‚   - Detailed account info saved to `output/full_account_capture.txt` (email:password:account_id:external_id)

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```---



---### ğŸ“¹ Preview



## ğŸ”¥ Features![Preview](https://i.imgur.com/c7yeYrQ.gif)



- âœ… **Production-Ready**: Currently handling Cybertemp's email traffic---

- âœ… **High Performance**: Async Rust with Tokio for concurrent connections

- âœ… **Dual Email System**: Supports both temporary and private emails### â— Disclaimers

- âœ… **Domain Whitelisting**: Accept emails only for configured domains

- âœ… **Ban System**: Block emails from specific senders/domains- This project is for educational purposes only

- âœ… **MIME Parsing**: Proper handling of plain text and HTML emails- The author is not responsible for any misuse of this tool

- âœ… **PostgreSQL Storage**: Reliable email storage with indexing- Use responsibly and in accordance with Crunchyroll's terms of service

- âœ… **Supabase Integration**: Automatic inbox management

- âœ… **Connection Pooling**: Efficient database connections---

- âœ… **Queue Management**: Prevents server overload with request limits

- âœ… **Heartbeat Monitoring**: Optional uptime monitoring endpoint### ğŸ“œ ChangeLog

- âœ… **Real-time Domain Updates**: Polls for domain/ban updates every 30-60s

- âœ… **Graceful Error Handling**: Detailed logging with tracing```diff

v0.0.1 â‹® 12/26/2024

---! Initial release with email verification and proxy support

````

## ğŸ“‹ Prerequisites

<p align="center">

- **Rust** 1.70+ (for compilation) <img src="https://img.shields.io/github/license/sexfrance/Crunchyroll-Account-Creator.svg?style=for-the-badge&labelColor=black&color=f429ff&logo=IOTA"/>

- **PostgreSQL** 12+ (for email storage) <img src="https://img.shields.io/github/stars/sexfrance/Crunchyroll-Account-Creator.svg?style=for-the-badge&labelColor=black&color=f429ff&logo=IOTA"/>

- **Supabase Account** (for inbox/domain management) <img src="https://img.shields.io/github/languages/top/sexfrance/Crunchyroll-Account-Creator.svg?style=for-the-badge&labelColor=black&color=f429ff&logo=python"/>

- **Linux/Windows/macOS** (any platform supporting Rust)</p>
- **Port 25 Access** (or alternative SMTP port - requires root/admin on Linux for port 25)

---

## âš™ï¸ Installation

### Using Rust (Recommended - Active Development)

> âš ï¸ **Note**: The JavaScript version is **NOT MAINTAINED**. Use the Rust implementation in the `rust/` directory.

1. **Install Rust** (if not already installed):

   ```bash
   # Linux/macOS
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

   # Windows
   # Download from https://rustup.rs/
   ```

2. **Clone the repository**:

   ```bash
   git clone https://github.com/sexfrance/smtp-server.git
   cd smtp-server/rust
   ```

3. **Build the project**:

   ```bash
   # Development build
   cargo build

   # Production build (optimized)
   cargo build --release
   ```

---

## ğŸ”§ Configuration

Create a `.env` file in the `rust/` directory with the following variables:

```env
# PostgreSQL Database (REQUIRED)
DATABASE_URL=postgresql://username:password@localhost:5432/cybertemp

# Supabase Configuration (REQUIRED)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# SMTP Server Settings (OPTIONAL)
SMTP_RECEIVE_PORT=25                    # Default: 25 (use 2525 for non-root testing)

# Heartbeat Monitoring (OPTIONAL)
HEARTBEAT_URL=https://your-monitoring-service.com/ping
```

### Environment Variables Explained

| Variable                    | Required | Description                                     |
| --------------------------- | -------- | ----------------------------------------------- |
| `DATABASE_URL`              | âœ… Yes   | PostgreSQL connection string for storing emails |
| `SUPABASE_URL`              | âœ… Yes   | Your Supabase project URL                       |
| `SUPABASE_SERVICE_ROLE_KEY` | âœ… Yes   | Supabase service role key (NOT anon key)        |
| `SMTP_RECEIVE_PORT`         | âŒ No    | SMTP port (default: 25)                         |
| `HEARTBEAT_URL`             | âŒ No    | Uptime monitoring ping URL                      |

---

## ğŸ’¾ Database Setup

### PostgreSQL Schema

Run the SQL schema located in `rust/SQL/schema.sql`:

```bash
psql -U your_user -d cybertemp -f rust/SQL/schema.sql
```

This creates:

- `emails` table - stores all temporary emails
- `private_email` table - optional private email accounts (see below)
- Necessary indexes for performance

### Supabase Tables

You need to create these tables in your Supabase project:

#### 1. `domains` table (Domain Whitelist)

```sql
CREATE TABLE domains (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  domain TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add your domains
INSERT INTO domains (domain) VALUES
  ('cybertemp.xyz'),
  ('temp-mail.xyz'),
  ('*.example.com');  -- Wildcard support
```

#### 2. `inbox` table (Inbox Management)

```sql
CREATE TABLE inbox (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email_address TEXT NOT NULL UNIQUE,
  user_id UUID,  -- Optional: link to auth.users
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 3. `bans` table (Email/Domain Blocking)

```sql
CREATE TABLE bans (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  scope TEXT NOT NULL,           -- 'email' or 'domain'
  value TEXT NOT NULL,            -- email address or domain
  match_type TEXT DEFAULT 'exact', -- 'exact' or 'contains'
  status TEXT DEFAULT 'active',   -- 'active' or 'inactive'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Example bans
INSERT INTO bans (scope, value, match_type, status) VALUES
  ('email', 'spam@example.com', 'exact', 'active'),
  ('email', 'spam', 'contains', 'active'),  -- Blocks any email containing "spam"
  ('domain', 'spammer.com', 'exact', 'active');
```

---

## ğŸš€ Running the Server

### Development Mode

```bash
cd rust
cargo run
```

### Production Mode

```bash
cd rust
cargo build --release
./target/release/cybertemp_smtp
```

### Running on Port 25 (Linux)

Port 25 requires root privileges:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant port binding capability (recommended)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp
./target/release/cybertemp_smtp
```

### Running as a Service (Systemd)

Create `/etc/systemd/system/cybertemp-smtp.service`:

```ini
[Unit]
Description=Cybertemp SMTP Server
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/smtp-server/rust
EnvironmentFile=/path/to/smtp-server/rust/.env
ExecStart=/path/to/smtp-server/rust/target/release/cybertemp_smtp
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable cybertemp-smtp
sudo systemctl start cybertemp-smtp
sudo systemctl status cybertemp-smtp
```

---

## ğŸ” How It Works

### Email Flow

1. **Connection**: External SMTP server connects to port 25
2. **SMTP Handshake**: Server responds with `220 Cybertemp Mail Receiver`
3. **Domain Check**: Recipient domain is validated against whitelist
4. **Ban Check**: Sender and domain are checked against ban list
5. **Email Receipt**: Server accepts email data until `.` terminator
6. **Parsing**: Email is parsed using `mailparse` crate
7. **Storage Decision**:
   - If recipient is in `private_email` table â†’ Store in PostgreSQL `emails` table
   - Otherwise â†’ Store in PostgreSQL as temporary email + create Supabase inbox
8. **Response**: Server responds with `250 Ok: Message accepted`

### Domain Whitelisting

The server **only accepts emails** for domains listed in Supabase `domains` table. This prevents abuse and unauthorized usage.

**Wildcard support**:

- `example.com` - matches exactly `example.com`
- `*.example.com` - matches `mail.example.com`, `temp.example.com`, etc.

**Automatic updates**: Domain list is refreshed every 60 seconds.

### Ban System

Protects against spam and abuse:

- **Email bans**: Block specific sender addresses
  - `exact` match: Must match exactly
  - `contains` match: Blocks if sender contains substring
- **Domain bans**: Block entire sending domains
- **Real-time updates**: Ban list refreshes every 30 seconds

---

## âš ï¸ Important Notes

### About Private Emails (`privatemail.sql`)

âš ï¸ **The `private_email` table is ONLY used by Cybertemp for premium features and is NOT required for basic SMTP functionality.**

**What it does**:

- Allows specific email addresses to have persistent storage
- Used for Cybertemp's paid private email accounts
- Completely optional for self-hosted deployments

**How to remove it**:

1. Delete or ignore `rust/SQL/privatemail.sql`
2. Remove the private email check in `main.rs` (lines ~409-447):
   ```rust
   // Remove this entire block:
   match sqlx::query("SELECT id FROM private_email WHERE email = $1 LIMIT 1")
       .bind(&recipient_email)
       .fetch_optional(postgres_pool)
       .await
   {
       // ... entire private email handling logic
   }
   ```

### Code Quality Disclaimer

âš ï¸ **This codebase is functional but not prettily written.** It's a working production system that evolved organically. Known issues:

- Long functions that should be split up
- Some error handling could be more elegant
- Duplicate code in fallback paths
- Comment clutter from debugging sessions

**But it works reliably** and handles thousands of emails daily for Cybertemp. Refactoring PRs welcome! ğŸ˜„

### JavaScript Version

âš ï¸ **The `javascript/` folder is NOT MAINTAINED** - it was an early prototype. Use the Rust version for all deployments.

---

## ğŸ› ï¸ Troubleshooting

### Common Issues

#### 1. "mismatched types - expected &str, found &Result<String, VarError>"

**Problem**: Environment variable not being unwrapped properly.

**Solution**: Make sure `.env` file exists and contains required variables. The error occurs when `env::var()` fails.

```rust
// Fix by adding .expect() or ?
let database_url = env::var("DATABASE_URL")
    .expect("DATABASE_URL must be set in .env file");
```

#### 2. "Failed to connect to PostgreSQL"

**Check**:

- PostgreSQL is running: `systemctl status postgresql`
- Database exists: `psql -l | grep cybertemp`
- Credentials are correct in `DATABASE_URL`
- Schema is initialized: `psql -d cybertemp -c "\dt"`

#### 3. "Failed to load domains from Supabase"

**Check**:

- Supabase URL is correct (https://your-project.supabase.co)
- Service role key is correct (NOT anon key)
- `domains` table exists in Supabase
- Network connectivity to Supabase

#### 4. "Permission denied" binding to port 25

**Solution**:

```bash
# Option 1: Run as root
sudo ./target/release/cybertemp_smtp

# Option 2: Grant capability (Linux only)
sudo setcap CAP_NET_BIND_SERVICE=+eip ./target/release/cybertemp_smtp

# Option 3: Use alternative port
SMTP_RECEIVE_PORT=2525 ./target/release/cybertemp_smtp
```

#### 5. Emails not appearing in database

**Check logs for**:

- Domain whitelist rejections
- Ban list rejections
- Database insertion errors
- Parsing errors

**Enable debug logging**:

```bash
RUST_LOG=debug ./target/release/cybertemp_smtp
```

---

## ğŸ“Š Development Status

| Component                     | Status               | Notes                                 |
| ----------------------------- | -------------------- | ------------------------------------- |
| **Rust Implementation**       | âœ… **Active**        | Production-ready, actively maintained |
| **JavaScript Implementation** | âŒ **Abandoned**     | Not maintained, use Rust version      |
| **PostgreSQL Storage**        | âœ… Production        | Stable and tested                     |
| **Supabase Integration**      | âœ… Production        | Stable and tested                     |
| **Private Email Feature**     | âš ï¸ Optional          | Cybertemp-specific, not required      |
| **Code Quality**              | âš ï¸ Needs Refactoring | Works but messy                       |
| **Documentation**             | âœ… Complete          | You're reading it!                    |

---

## ğŸ“œ ChangeLog

```diff
v0.3.0 â‹® 11/01/2025
+ Comprehensive documentation rewrite
+ Clarified private email feature is optional
+ Added extensive troubleshooting guide
+ Documented Supabase table schemas
+ Added systemd service configuration

v0.2.0 â‹® 09/2024
+ Ban system implementation (email/domain blocking)
+ Real-time domain whitelist updates
+ Improved MIME parsing with fallbacks
+ Connection queue management
+ Heartbeat monitoring support

v0.1.0 â‹® 06/2024
! Initial production deployment for Cybertemp
+ PostgreSQL storage implementation
+ Supabase integration
+ Domain whitelisting
+ Private email support
+ Async Tokio runtime
```

---

## ğŸ“ Support

- **Discord**: [discord.cyberious.xyz](https://discord.cyberious.xyz)
- **Email**: support@cybertemp.xyz
- **Issues**: [GitHub Issues](https://github.com/sexfrance/smtp-server/issues)

---

## ğŸ“„ License

MIT License - See LICENSE file for details

---

## ğŸ™ Acknowledgments

- Built with â¤ï¸ for the Cybertemp community
- Powered by Rust ğŸ¦€, Tokio, and PostgreSQL
- Integrated with Supabase for scalable infrastructure

---

<p align="center">
  <img src="https://img.shields.io/badge/Rust-000000?style=for-the-badge&logo=rust&logoColor=white"/>
  <img src="https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white"/>
  <img src="https://img.shields.io/badge/Supabase-181818?style=for-the-badge&logo=supabase&logoColor=white"/>
  <img src="https://img.shields.io/badge/Production-Ready-success?style=for-the-badge"/>
</p>

<div align="center">
  <strong>â­ Star this repo if you found it helpful!</strong>
  <br />
  <sub>Currently powering Cybertemp's email infrastructure ğŸš€</sub>
</div>
<div align="center">
